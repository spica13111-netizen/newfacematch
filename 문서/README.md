# 상품 매칭 프로그램

구글 스프레드시트의 주문 데이터와 엑셀 상품 마스터를 자동 매칭하는 Streamlit 기반 웹 프로그램입니다.

## 주요 기능

### 1. 자동 상품 매칭 (파이프라인)
- 구글 스프레드시트에서 실시간으로 주문 데이터 로드
- 엑셀 파일의 전체 상품 마스터 데이터 로드
- **2단계 자동 매칭 파이프라인**:
  1. **100% 일치**: 시트 상품명과 엑셀 상품명이 완전히 일치
  2. **모델명 100% 일치**: 정규화된 모델명이 시트 상품명에 포함
- **유사도 기반 수동 매칭**: 자동 매칭 실패 시 상위 3-10개의 유사 상품 추천

### 2. 이미지 미리보기
- 각 추천 상품의 이미지를 100x100 크기로 미리보기 제공
- URL 기반 이미지 자동 다운로드 및 리사이즈

### 3. 구글 시트 자동 업데이트
- 매칭 완료 시 `[매칭상품]` 탭에 자동 기록
- 기록 정보:
  - **상품명**: 엑셀에서 매칭된 정확한 상품명
  - **매입**: 입고가계
  - **매출**: 공급가(V+) 배송비 포함
  - **매입(업체)**: 운영사
  - **탭**: 엑셀의 어느 탭에서 가져왔는지
  - **매칭이미지**: 상품 이미지 (100x100)
  - **매칭방식**: "100%일치", "모델명100%일치", "수동매칭"
- 이미 값이 있는 행은 건너뛰기 (중복 방지)

### 4. 스프레드시트 실시간 보기
- 별도 탭에서 구글 스프레드시트 내용 확인
- 시트1 (주문 데이터) 및 매칭상품 탭 실시간 조회

### 5. 스프레드시트 바로가기
- 사이드바에서 원클릭으로 구글 스프레드시트 접속

## 사용 방법

### 1. 사전 준비

#### Google API 인증 파일 준비
1. Google Cloud Console에서 프로젝트 생성
2. Google Sheets API 및 Google Drive API 활성화
3. 서비스 계정 생성 후 JSON 키 다운로드
4. 다운로드한 JSON 파일을 `config/` 폴더에 저장
5. 구글 스프레드시트를 서비스 계정 이메일과 공유 (편집 권한)

#### 구글 스프레드시트 구조
스프레드시트 이름: **상품매칭용시트**

**시트1** (주문 데이터):
```
발주일자 | 구매일자 | 매입(업체) | 매출(MALL) | 주문자명 | ... | 상품명 | 수량 | 매출 | 배송비 | 매입 | M | 비고
```

**매칭상품** 탭 (자동 생성):
```
상품명 | 매입 | 매출 | 매입(업체) | 탭 | 매칭이미지 | 매칭방식
```

#### 엑셀 파일 구조
- 여러 탭 구조 (예: 가전, 생활용품, 주방용품 등)
- `[월말재고현황]` 탭은 자동으로 제외됨
- 각 탭의 1행은 헤더

**필수 컬럼**:
```
상품명 | 입고가계 | 공급가(V+) 배송비 포함 | 운영사 | 대표 1 | 모델명
```
- **모델명**: 자동 매칭에 사용됨 (선택사항이지만 권장)

### 2. 설치

```bash
# 패키지 설치
pip install -r requirements.txt
```

### 3. 실행

#### Windows:
```bash
run.bat
```

#### PowerShell:
```powershell
.\run.ps1
```

#### 직접 실행:
```bash
streamlit run app.py
```

### 4. 프로그램 사용

1. **페이지 선택**
   - 사이드바에서 "상품 매칭" 또는 "스프레드시트 보기" 선택

2. **엑셀 파일 업로드**
   - 사이드바에서 상품 마스터 엑셀 파일 업로드
   - 자동으로 모든 탭 로드 (`[월말재고현황]` 제외)
   - 임시 파일은 `temp/` 폴더에 저장 후 자동 삭제

3. **매칭 설정**
   - 최소 유사도: 50-100% (기본 70%)
   - 추천 상품 개수: 3-10개 (기본 5개)

4. **자동 매칭**
   - 프로그램이 자동으로 2단계 매칭 시도:
     1. 상품명 100% 일치 확인
     2. 모델명 100% 포함 확인
   - 자동 매칭 성공 시 바로 구글 시트에 기록
   - 매칭 방식이 "100%일치" 또는 "모델명100%일치"로 표시됨

5. **수동 매칭** (자동 매칭 실패 시)
   - 메인 화면에 매칭 대기 중인 주문이 표시됨
   - 각 주문별로 유사 상품 추천 리스트가 나타남
   - 이미지를 확인하고 `✅ 매칭하기` 버튼 클릭
   - 매칭 방식이 "수동매칭"으로 표시됨

6. **결과 확인**
   - 구글 스프레드시트의 `[매칭상품]` 탭에서 확인
   - 또는 "스프레드시트 보기" 페이지에서 실시간 확인
   - 매칭된 주문은 자동으로 리스트에서 제거됨

## 기술 스택

- **Streamlit**: 웹 UI 프레임워크
- **gspread**: 구글 스프레드시트 API 연동
- **pandas**: 데이터 처리
- **openpyxl**: 엑셀 파일 읽기
- **rapidfuzz**: 빠른 문자열 유사도 매칭
- **Pillow**: 이미지 다운로드 및 리사이즈
- **requests**: HTTP 요청 (이미지 다운로드)

## 프로젝트 구조

```
.
├── app.py                  # 메인 Streamlit 앱
├── requirements.txt        # 패키지 의존성
├── run.bat                 # Windows 실행 스크립트
├── run.ps1                 # PowerShell 실행 스크립트
├── README.md               # 프로젝트 문서
├── STRUCTURE.md            # 상세 구조 문서
├── config/                 # 설정 파일
│   └── Google Sheets API.json
└── src/                    # 소스 코드 모듈
    ├── utils.py            # 구글 시트/엑셀 처리
    ├── matcher.py          # 유사도 매칭 로직
    └── image_handler.py    # 이미지 다운로드/처리
```

## 주요 기능 설명

### 자동 매칭 파이프라인
1. **100% 일치**: 시트 상품명과 엑셀 상품명을 문자 그대로 비교
2. **모델명 100% 일치**:
   - 시트 상품명과 엑셀 모델명을 정규화 (공백/특수문자 제거, 소문자 변환)
   - 정규화된 모델명이 정규화된 시트 상품명에 포함되는지 확인
3. 자동 매칭 성공 시 즉시 구글 시트 업데이트

### 유사도 매칭 알고리즘
- **rapidfuzz**의 `token_set_ratio` 사용
- 단어 순서 무관, 띄어쓰기 무관
- 오타 허용 (예: "쿨 냉장고" ↔ "쿠ㄹ 냉장고")
- 유사도 점수 0-100% 계산

### 문자열 정규화
- 공백 제거
- 특수문자 제거
- 알파벳 소문자 변환
- 한글, 영문, 숫자만 유지

### 이미지 처리
1. URL에서 이미지 다운로드
2. 100x100 픽셀로 자동 리사이즈
3. JPEG 형식으로 최적화
4. 구글 시트에 IMAGE 함수로 삽입

### 중복 방지
- 이미 매칭된 행(상품명이 있는 행)은 건너뛰기
- 같은 주문을 중복으로 매칭하지 않음

## 문제 해결

### "구글 API 인증 오류"
- `config/` 폴더에 JSON 파일이 있는지 확인
- JSON 파일 이름에 "Sheets API" 또는 "Sheet" 포함 권장
- 서비스 계정 이메일로 스프레드시트 공유 확인

### "스프레드시트를 찾을 수 없습니다"
- 스프레드시트 이름이 정확히 "상품매칭용시트"인지 확인
- 서비스 계정과 공유되었는지 확인 (편집 권한)

### "상품명 컬럼을 찾을 수 없습니다"
- 시트1의 헤더에 "상품명" 컬럼 존재 확인
- 1행이 헤더인지 확인

### "유사한 상품을 찾지 못했습니다"
- 최소 유사도 값을 낮춰보세요 (50%까지)
- 엑셀 파일에 해당 상품이 있는지 확인
- 엑셀 파일의 "상품명" 컬럼이 있는지 확인

## 버전 정보

- **v3.0** (현재): 자동 매칭 파이프라인 추가
  - 2단계 자동 매칭 (100% 일치, 모델명 100% 일치)
  - 문자열 정규화 기능
  - 매칭 방식 기록
  - 스프레드시트 실시간 보기
  - 스프레드시트 바로가기
  - temp 폴더 관리
  - 중복 매칭 방지

- **v2.0**: 완전히 새로운 상품 매칭 시스템
  - 유사도 기반 자동 매칭
  - 이미지 미리보기 지원
  - 다중 탭 엑셀 지원
  - 실시간 구글 시트 업데이트

## 라이선스

MIT License

## 지원

문의사항이나 버그 리포트는 개발자에게 문의하세요.
